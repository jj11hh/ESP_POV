#include <stdint.h>
#include <FixedPoints.h>
#include <FixedPointsCommon.h>
#include <SPI.h>
#include <math.h>

#include "EspTLC5947.h"
#include "common.h"
#include "FixedPointsMath.h"
#include "font5x7.h"
#include "display.h"

static uint8_t init_image[128 * 16 * 3] PROGMEM = {
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 199, 35, 57, 45, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 56, 46, 8, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 46, 8, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 254, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 9, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 243, 194, 34, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 55, 44, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 34, 74, 61, 14, 
247, 194, 34, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 45, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 251, 198, 34, 12, 10, 3, 
223, 176, 30, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 44, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 252, 199, 34, 13, 11, 2, 
212, 168, 30, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 253, 199, 34, 23, 19, 5, 
202, 160, 29, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 9, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 31, 26, 6, 
193, 153, 27, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 54, 44, 9, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 34, 40, 32, 7, 
183, 145, 26, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 56, 45, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 50, 41, 7, 
175, 139, 25, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 45, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 59, 47, 9, 
166, 133, 24, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 54, 44, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 66, 54, 10, 
158, 126, 23, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 54, 44, 9, 196, 196, 196, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 76, 61, 12, 
149, 119, 22, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 54, 44, 8, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 81, 66, 12, 
142, 113, 20, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 54, 44, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 90, 72, 14, 
134, 107, 20, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 54, 44, 8, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 95, 77, 13, 
128, 103, 19, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 53, 43, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 103, 82, 15, 
123, 98, 18, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 45, 9, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 107, 86, 15, 
116, 93, 17, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 44, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 113, 90, 16, 
112, 89, 16, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 55, 45, 9, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 119, 94, 17, 
108, 86, 15, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 46, 8, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 123, 98, 17, 
103, 82, 14, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 54, 44, 9, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 125, 100, 18, 
99, 79, 13, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 55, 45, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 128, 102, 18, 
96, 77, 14, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 130, 103, 18, 
96, 76, 13, 255, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 199, 35, 134, 107, 19, 
91, 72, 13, 255, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 8, 195, 195, 195, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 134, 107, 19, 
92, 73, 13, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 44, 8, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 134, 107, 19, 
92, 73, 13, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 44, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 199, 35, 135, 108, 19, 
90, 71, 13, 255, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 46, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 134, 106, 19, 
94, 75, 13, 255, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 47, 9, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 130, 103, 18, 
95, 75, 13, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 47, 8, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 131, 104, 18, 
94, 75, 13, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 47, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 128, 102, 18, 
98, 78, 14, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 59, 47, 10, 190, 190, 190, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 123, 99, 18, 
103, 82, 15, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 59, 48, 8, 190, 190, 190, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 119, 95, 17, 
106, 84, 15, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 60, 49, 9, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 114, 91, 16, 
109, 87, 17, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 60, 49, 9, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 111, 88, 17, 
114, 91, 17, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 62, 50, 10, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 104, 83, 14, 
119, 95, 18, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 61, 50, 10, 187, 187, 187, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 98, 79, 15, 
125, 100, 19, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 62, 51, 10, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 93, 75, 14, 
132, 105, 19, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 63, 51, 10, 187, 187, 187, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 85, 69, 13, 
140, 112, 20, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 63, 50, 9, 187, 187, 187, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 77, 62, 11, 
146, 116, 21, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 63, 51, 10, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 68, 55, 11, 
151, 121, 22, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 65, 52, 11, 185, 185, 185, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 62, 50, 9, 
162, 128, 23, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 66, 54, 10, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 54, 44, 9, 
171, 135, 24, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 66, 54, 10, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 44, 36, 7, 
179, 142, 26, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 66, 54, 11, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 34, 37, 30, 7, 
188, 149, 27, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 66, 54, 11, 182, 182, 182, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 27, 22, 5, 
197, 156, 28, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 67, 54, 10, 181, 181, 181, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 253, 200, 35, 22, 19, 5, 
208, 165, 29, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 67, 55, 11, 180, 180, 180, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 34, 74, 61, 14, 
239, 188, 33, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 69, 56, 10, 180, 180, 180, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 200, 35, 241, 192, 33, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 70, 56, 10, 179, 179, 179, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 199, 35, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 70, 56, 11, 179, 179, 179, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 70, 56, 10, 178, 178, 178, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 70, 57, 10, 178, 178, 178, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 70, 57, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 199, 35, 70, 57, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 72, 58, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 71, 57, 11, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 200, 35, 254, 199, 35, 254, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 199, 35, 72, 58, 10, 175, 175, 175, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 200, 35, 254, 200, 35, 254, 199, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 199, 35, 73, 58, 10, 175, 175, 175, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 200, 35, 206, 167, 29, 247, 196, 34, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 71, 57, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
248, 196, 34, 33, 27, 6, 169, 136, 25, 254, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 72, 58, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
219, 174, 30, 1, 0, 0, 76, 62, 13, 254, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 71, 57, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
181, 145, 25, 0, 0, 0, 13, 11, 3, 245, 194, 34, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 71, 57, 10, 176, 176, 176, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
158, 126, 22, 0, 0, 0, 0, 0, 1, 201, 160, 28, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 71, 57, 11, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
144, 115, 21, 0, 0, 0, 0, 0, 0, 151, 120, 22, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 71, 57, 10, 177, 177, 177, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
138, 110, 19, 0, 0, 0, 0, 0, 0, 106, 85, 15, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 71, 57, 10, 178, 178, 178, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
140, 112, 19, 0, 0, 0, 0, 0, 0, 64, 51, 9, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 70, 57, 10, 179, 179, 179, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
143, 113, 20, 0, 0, 0, 0, 0, 0, 24, 20, 3, 
253, 199, 34, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 70, 57, 10, 179, 179, 179, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
159, 126, 22, 0, 0, 0, 0, 0, 0, 3, 2, 1, 
241, 190, 33, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 69, 56, 11, 178, 178, 178, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
179, 142, 25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
219, 173, 30, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 69, 56, 11, 180, 180, 180, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
201, 158, 28, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
199, 158, 28, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 68, 55, 10, 180, 180, 180, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
236, 187, 33, 2, 1, 0, 0, 0, 0, 0, 0, 0, 
191, 151, 27, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 67, 54, 10, 182, 182, 182, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 200, 34, 30, 25, 4, 0, 0, 0, 0, 0, 0, 
192, 152, 27, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 68, 55, 10, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 199, 35, 89, 72, 13, 0, 0, 0, 0, 0, 0, 
212, 167, 30, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 68, 55, 9, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 180, 144, 25, 2, 2, 2, 21, 16, 4, 
245, 194, 34, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 66, 53, 10, 182, 182, 182, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 251, 198, 34, 115, 94, 18, 153, 123, 22, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 66, 53, 10, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 252, 200, 34, 253, 200, 35, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 65, 53, 10, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 254, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 65, 53, 10, 184, 184, 184, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 65, 53, 11, 185, 185, 185, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 63, 51, 10, 185, 185, 185, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 63, 51, 10, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 64, 51, 9, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 63, 50, 9, 186, 186, 186, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 62, 50, 10, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 61, 49, 9, 187, 187, 187, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 61, 49, 9, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 61, 49, 8, 189, 189, 189, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 60, 49, 8, 188, 188, 188, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 60, 49, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 58, 47, 8, 189, 189, 189, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 58, 47, 8, 190, 190, 190, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 60, 48, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 59, 47, 8, 190, 190, 190, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 59, 48, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 58, 47, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 47, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 8, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 199, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 9, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 199, 35, 255, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 9, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
241, 194, 34, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 56, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
108, 90, 17, 244, 194, 34, 254, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 56, 46, 9, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 251, 198, 34, 
19, 16, 5, 146, 118, 23, 253, 200, 35, 254, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 56, 46, 9, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 248, 196, 34, 
8, 7, 2, 16, 14, 6, 195, 157, 28, 254, 200, 35, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 248, 196, 34, 
9, 7, 2, 0, 0, 1, 25, 20, 6, 177, 143, 25, 
252, 199, 34, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 252, 198, 34, 
25, 21, 4, 0, 0, 0, 0, 0, 0, 6, 5, 2, 
105, 85, 15, 253, 199, 34, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 8, 194, 194, 194, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
48, 39, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
2, 2, 2, 232, 184, 32, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 55, 44, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 199, 35, 
86, 70, 12, 29, 24, 6, 82, 68, 14, 23, 19, 5, 
12, 9, 3, 241, 190, 33, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 199, 35, 
120, 96, 18, 20, 16, 3, 242, 195, 34, 231, 186, 32, 
213, 171, 30, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 200, 35, 
174, 139, 25, 0, 0, 1, 197, 157, 27, 254, 199, 35, 
254, 200, 35, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
221, 176, 30, 3, 3, 2, 127, 103, 19, 254, 199, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 46, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
252, 199, 34, 35, 29, 6, 47, 38, 8, 250, 198, 34, 
254, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 56, 45, 9, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 200, 35, 108, 86, 16, 2, 2, 1, 197, 158, 27, 
255, 199, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 58, 47, 9, 192, 192, 192, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
254, 199, 35, 189, 151, 27, 2, 1, 1, 86, 69, 13, 
254, 199, 34, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 47, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 248, 196, 34, 46, 37, 7, 4, 3, 2, 
197, 157, 28, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 58, 46, 9, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 162, 129, 23, 0, 0, 0, 
110, 88, 17, 254, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 199, 35, 247, 196, 34, 63, 52, 11, 
118, 93, 17, 254, 199, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 46, 8, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 254, 199, 35, 221, 177, 31, 
217, 173, 30, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 9, 191, 191, 191, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 254, 199, 35, 
254, 199, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 200, 35, 57, 45, 8, 193, 193, 193, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 255, 200, 35, 255, 200, 35, 255, 200, 35, 
255, 200, 35, 254, 199, 35, 57, 46, 8, 191, 191, 191, 
};

volatile uint32_t time_last_scanned = 0;
volatile uint32_t last_duration = 0;

uint8_t brightness = 1;
uint32_t scanRotate = 5 * SCANLINE / 6;
uint32_t data_array[TLC_NUM * TLC_WORD] = {0};
uint8_t pov_buf_bg[SCANLINE * SUBPIXEL_NUM];
uint8_t pov_buf[SCANLINE * SUBPIXEL_NUM];
uint8_t gamma8[256] = {0};


static void genGamma8(uint8_t *to, float gamma){
  for (int i = 0; i < 256; i ++){
    to[i] = round(pow(i / 255.0, gamma) * 255);
  }
}

void setupDisplay(){
  SPI.begin();
  SPI.setFrequency(40000000);
  SPI.setBitOrder(MSBFIRST);
  pinMode(LATCH_PIN, OUTPUT);
  pinMode(HALL_PIN, INPUT_PULLUP);

  tlc_clear(data_array, TLC_NUM);
  tlc_write(data_array, TLC_NUM, LATCH_PIN, -1);

  for (uint32_t i = 0; i < SCANLINE * SUBPIXEL_NUM; i ++)
  {
    pov_buf_bg[i] = pgm_read_byte(init_image + i);  
    pov_buf[i] = pov_buf_bg[i];
  }

  genGamma8(gamma8, 3.0);
  attachInterrupt(digitalPinToInterrupt(HALL_PIN), handleHall, FALLING);
}


void ICACHE_RAM_ATTR handleHall(void){
  uint32_t time_now = micros();
  uint32_t duration = time_now - time_last_scanned;

  last_duration = duration;
  time_last_scanned = time_now;
}

void ICACHE_RAM_ATTR pov_update(){
  static uint16_t lastScan = 0;
  uint16_t scan = 0;
  if (last_duration != 0)
    scan = ((micros() - time_last_scanned) * SCANLINE / last_duration);
  scan %= SCANLINE;
  if (scan == lastScan)
    //return 0;
    return;
  lastScan = scan;
  for (uint8_t i = 0; i < TLC_CHAN * 2; i++){
    uint32_t line = (scan + scanRotate) % SCANLINE;
    uint32_t p = gamma8[pov_buf[line * 2 * TLC_CHAN + i]] * brightness * (i/3 + 1) / LEDNUM;
    tlc_setpwm(data_array, TLC_NUM, led_map[i], p);
  }
  tlc_write(data_array, TLC_NUM, LATCH_PIN, -1);
  //return 1;
}

SQ15x16 polorDistance(SQ15x16 r1, SQ15x16 a1, SQ15x16 r2, SQ15x16 a2){
  SQ15x16 da = minfp(absfp(a1-a2), SQ15x16::Pi * 2 -absfp(a1-a2));
  return sqrtfp(r1*r1 + r2*r2 - 2*cosfp(da)*r1*r2);
}

SQ15x16 calcSdfCircle(SQ15x16 r, SQ15x16 theta, SQ15x16 R, SQ15x16 pr, SQ15x16 ptheta){
  SQ15x16 diff = polorDistance(pr, ptheta, r, theta) - R;
  if (diff < -1){
    return 1;
  }
  if (diff < 0){
    return - diff;
  }
  else {
    return 0;
  }
}

void clearCircle(SQ15x16 r, SQ15x16 theta, SQ15x16 R){
  SQ15x16 d = r - R;
  SQ15x16 angleRange;
  int startRing, endRing, startScan, endScan;
  if (d >= 0){
    startRing = (d - 1).getInteger();
    endRing = min((r + R).getInteger() + 1, LEDNUM);
    angleRange = atan2fp(R, r);
    startScan = (((theta - angleRange) / (2 * SQ15x16::Pi)) * SCANLINE).getInteger() - 1;
    endScan = (((theta + angleRange) / (2 * SQ15x16::Pi)) * SCANLINE).getInteger() + 1;
  }   
  else {
    startRing = (d - 1).getInteger();
    endRing = min((r + R).getInteger() + 1, LEDNUM);
    startScan = 0;
    endScan = SCANLINE;
  }

  for (int i = startRing; i < endRing; i ++){
    for (int j = startScan; j < endScan; j ++){
      int n = abs(i);
      int s = PMOD(j, SCANLINE);
      if (n > LEDNUM)
        break;
      Color c;
      POV_GET_PIXEL(pov_buf_bg, n, s, &c);
      POV_SET_PIXEL(pov_buf, n, s, c);
    }
    pov_update();
  }
}

void fillCircle(SQ15x16 r, SQ15x16 theta, SQ15x16 R, Color color){
  SQ15x16 d = r - R;
  SQ15x16 angleRange;
  int startRing, endRing, startScan, endScan;
  if (d >= 0){
    startRing = (d - 1).getInteger();
    endRing = min((r + R).getInteger() + 1, LEDNUM);
    angleRange = atan2fp(R, r);
    startScan = (((theta - angleRange) / (2 * SQ15x16::Pi)) * SCANLINE).getInteger() - 1;
    endScan = (((theta + angleRange) / (2 * SQ15x16::Pi)) * SCANLINE).getInteger() + 1;
  }   
  else {
    startRing = (d - 1).getInteger();
    endRing = min((r + R).getInteger() + 1, LEDNUM);
    startScan = 0;
    endScan = SCANLINE;
  }
  for (int i = startRing; i < endRing; i ++){
    for (int j = startScan; j < endScan; j ++){
      int n = abs(i);
      int s = PMOD(j, SCANLINE);
      if (n > LEDNUM)
        break;
      
      SQ15x16 pr = n;
      SQ15x16 ptheta = s * 2 * SQ15x16::Pi / SCANLINE;
      SQ15x16 sdf = calcSdfCircle(r, theta, R, pr, ptheta);
      Color c_ori;
      POV_GET_PIXEL(pov_buf, n, s, &c_ori);
      c_ori.r = (c_ori.r * (1-sdf)).getInteger(); c_ori.r += (sdf*color.r).getInteger();
      c_ori.g = (c_ori.g * (1-sdf)).getInteger(); c_ori.g += (sdf*color.g).getInteger();
      c_ori.b = (c_ori.b * (1-sdf)).getInteger(); c_ori.b += (sdf*color.b).getInteger();
      POV_SET_PIXEL(pov_buf, n, s, c_ori);
      pov_update(); 
    }
  }
}

void clearText5x7(uint32_t r, int32_t s, const char* text, bool flip){
  for (uint32_t i = 0; text[i]; i ++){
    if (text[i] < ' ' || text[i] >= 128)
      continue;
    Color c;
    for (uint8_t y = 0; y < 7; y ++){
      for (uint8_t x = 0; x < 5; x ++){
          if (!flip){
            if (r + y < LEDNUM){
              POV_GET_PIXEL(pov_buf_bg, r+y, PMOD((s+x), SCANLINE), &c);
              POV_SET_PIXEL(pov_buf, r+y, PMOD((s+x), SCANLINE), c);
            }
          }
          else{
            if (r + y < LEDNUM){
              POV_GET_PIXEL(pov_buf_bg, r+y, PMOD((s-x), SCANLINE), &c);
              POV_SET_PIXEL(pov_buf, r+y, PMOD((s-x), SCANLINE), c);
            }
          }
      }
    }
    pov_update();
    if (!flip)
      s += 6;
    else
      s -= 6;
  }
}

void drawText5x7(uint32_t r, int32_t s, const char* text, Color color, bool flip){
  for (uint32_t i = 0; text[i]; i ++){
    if (text[i] < ' ' || text[i] >= 128)
      continue;

    for (uint8_t y = 0; y < 7; y ++){
      for (uint8_t x = 0; x < 5; x ++){
        if (!flip){
          if (r + y < LEDNUM && (font5x7[text[i]-32][6 - y] & (1 << (4 - x))))
            POV_SET_PIXEL(pov_buf, r+y, PMOD((s+x), SCANLINE), color);
        }
        else{
          if (r + y < LEDNUM && (font5x7[text[i]-32][y] & (1 << (4 - x))))
            POV_SET_PIXEL(pov_buf, r+y, PMOD((s-x), SCANLINE), color);
        }
      }
    }
    pov_update();
    
    if (!flip)
      s += 6;
    else
      s -= 6;
  }
}
